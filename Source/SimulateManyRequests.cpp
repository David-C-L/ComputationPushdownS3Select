#include <iostream>
#include <vector>
#include <thread>
#include <string>
#include <cstdlib> // For system()

inline std::vector<std::string> getBounds() {
  return {
    "0-749,1544551699-1544551990",
    "1544473056-1544551699",
    "1268028-2220734,2933017-3092550",
    "6850197-7802903,8515935-8674719",
    "12431617-13383575,14096606-14256140",
    "18013787-18965744,19678776-19838309",
    "23594458-24547164,25260196-25418980",
    "29175129-30127086,30840118-30999651",
    "34755801-35707758,36420789-36580323",
    "40336472-41289178,42001461-42160994",
    "45917892-46869849,47582881-47742414",
    "51499312-52452018,53165050-53323835",
    "57079984-58031941,58744972-58903757",
    "62659906-63611863,64324895-64484428",
    "68243573-69196279,69909311-70068095",
    "73826491-74778448,75491480-75651013",
    "79407163-80359869,81072900-81231685",
    "84990081-85942038,86655070-86814603",
    "90570003-91521960,92234992-92394525",
    "96149925-97102631,97814914-97974448",
    "101730597-102682554,103395585-103555119",
    "107312766-108264723,108977755-109136539",
    "112893437-113845394,114558426-114717959",
    "118474857-119426815,120139846-120298631",
    "124052533-125005239,125717522-125877055",
    "129633953-130585910,131298942-131458475",
    "135216122-136168079,136881111-137040644",
    "140797542-141749500,142462531-142622065",
    "146378214-147330171,148043203-148202736",
    "151960383-152912340,153625372-153784905",
    "157539556-158491513,159204545-159363329",
    "163121725-164074432,164786714-164946248",
    "168703146-169655103,170368135-170526919",
    "174284566-175236523,175949555-176108339",
    "179865237-180817194,181530226-181689759",
    "185447406-186400113,187113144-187271929",
    "191029576-191982282,192695314-192854098",
    "196610996-197563702,198276734-198435518",
    "202191667-203143624,203856656-204015440",
    "207773836-208726543,209438825-209598359",
    "213355257-214307214,215020246-215179030",
    "218936677-219889383,220601666-220761199",
    "224518846-225471552,226183835-226343368",
    "230100266-231052973,231765255-231924789",
    "235683185-236635142,237348174-237506958",
    "241264605-242217311,242929594-243089127",
    "246847523-247800229,248512512-248672045",
    "252428943-253380901,254093932-254253466",
    "258010364-258962321,259675353-259834886",
    "263593282-264545239,265258271-265417804",
    "269174702-270126659,270839691-270999224",
    "274756122-275708080,276421111-276580645",
    "280338292-281290998,282003280-282162814",
    "285919712-286872418,287585450-287744234",
    "291501132-292453838,293166870-293325654",
    "297081803-298034510,298747541-298906326",
    "302663973-303615930,304328961-304488495",
    "308244644-309196601,309909633-310069166",
    "313826813-314778770,315491802-315651335",
    "319406735-320358693,321071724-321231258",
    "324988905-325940862,326653893-326812678",
    "330569576-331522282,332235314-332394098",
    "336151745-337103702,337816734-337975518",
    "341730918-342683625,343396656-343555441",
    "347313088-348265794,348978826-349137610",
    "352895257-353847214,354560246-354719779",
    "358478924-359431630,360143913-360303446",
    "364061093-365013051,365726082-365885616",
    "369641016-370593722,371306753-371465538",
    "375222436-376174393,376887425-377046958",
    "380803107-381755813,382468096-382627629",
    "386386025-387338732,388051014-388210548",
    "391968195-392920152,393633183-393792717",
    "397550364-398502321,399215353-399374886",
    "403131784-404083741,404796773-404956306",
    "408714702-409666659,410379691-410539225",
    "414296123-415248829,415961111-416120645",
    "419879041-420830998,421544030-421703563",
    "425461959-426413916,427126948-427286481",
    "431044128-431996085,432709117-432867901",
    "436624799-437577506,438290537-438449322",
    "442206220-443158926,443871958-444030742",
    "447787640-448739597,449452629-449611413",
    "453368311-454321017,455034049-455192833",
    "458950480-459902438,460615469-460775003",
    "464531152-465483109,466196141-466355674",
    "470111074-471063780,471776812-471935596",
    "475691745-476643702,477356734-477516268",
    "481273166-482225123,482938154-483097688",
    "486853837-487805794,488518826-488678359",
    "492433759-493385716,494098748-494258281",
    "498015179-498967886,499680917-499839702",
    "503596600-504549306,505261588-505421122",
    "509178020-510130726,510843009-511002542",
    "514760938-515712895,516425927-516585460",
    "520341609-521293567,522006598-522166132",
    "525923030-526874987,527588018-527747552",
    "531503701-532456407,533169439-533328223",
    "537085121-538037827,538750859-538909643",
    "542666541-543618499,544331530-544490315",
    "548247962-549199919,549912950-550071735",
    "553828633-554780590,555493622-555653155",
    "559410053-560362759,561075042-561234575",
    "564992222-565944180,566657211-566815996",
    "570572145-571524102,572237134-572396667",
    "576155063-577107020,577820052-577978836",
    "581735734-582688440,583401472-583560256",
    "587318652-588270610,588983641-589143175",
    "592900073-593852030,594565061-594724595",
    "598480744-599432701,600145733-600304517",
    "604059917-605011874,605724906-605883690",
    "609640588-610593295,611305577-611465111",
    "615222758-616174715,616887747-617047280",
    "620804178-621756135,622469167-622628700",
    "626386347-627338304,628051336-628210869",
    "631967767-632920474,633632756-633792290",
    "637549937-638501894,639214926-639373710",
    "643130608-644082565,644795597-644955130",
    "648712028-649664734,650377017-650536550",
    "654292699-655245406,655957688-656117222",
    "659874869-660827575,661539858-661699391",
    "665454791-666406748,667119780-667279313",
    "671036960-671988917,672701949-672860733",
    "676619129-677571836,678284118-678443652",
    "682201299-683154005,683866288-684025821",
    "687780472-688733178,689445461-689604994",
    "693362641-694314598,695027630-695187163",
    "698943312-699896019,700609050-700767835",
    "704524733-705476690,706189722-706349255",
    "710106902-711058859,711771891-711931424",
    "715689071-716641028,717354060-717513593",
    "721271240-722223947,722936229-723095763",
    "726852661-727804618,728517650-728677183",
    "732435579-733387536,734100568-734260101",
    "738016999-738969705,739682737-739841521",
    "743600666-744552624,745265655-745425189",
    "749182087-750134793,750847075-751006609",
    "754763507-755715464,756428496-756588029",
    "760345676-761298382,762010665-762170198",
    "765927096-766879803,767592834-767751619",
    "771509266-772461223,773174254-773333788",
    "777089937-778042643,778755675-778914459",
    "782669859-783621816,784334848-784494381",
    "788250530-789203237,789916268-790075053",
    "793831202-794783159,795496191-795655724",
    "799413371-800365328,801078360-801237893",
    "804994791-805946748,806659780-806819313",
    "810576211-811528918,812241200-812400734",
    "816158381-817110338,817823370-817982154",
    "821739801-822691758,823404790-823564323",
    "827320472-828272429,828985461-829144245",
    "832901143-833853101,834566132-834725666",
    "838484062-839436019,840149051-840308584",
    "844066231-845018188,845731220-845890004",
    "849647651-850599608,851312640-851472173",
    "855229071-856181029,856894060-857053594",
    "860808994-861760951,862473983-862632767",
    "866388167-867340873,868053905-868212689",
    "871970336-872923042,873636074-873794858",
    "877551756-878504463,879216745-879376279",
    "883133177-884085134,884798166-884957699",
    "888714597-889667303,890380335-890539119",
    "894297515-895250221,895963253-896122037",
    "899879684-900831642,901544673-901704207",
    "905460356-906413062,907126094-907284878",
    "911042525-911994482,912707514-912867047",
    "916623945-917576651,918288934-918448467",
    "922205365-923157323,923870354-924029888",
    "927786786-928739492,929452524-929611308",
    "933368206-934320163,935033195-935191979",
    "938948877-939901583,940614615-940773399",
    "944530297-945482255,946195286-946354820",
    "950113216-951065173,951778205-951937738",
    "955693887-956646593,957359625-957518409",
    "961276056-962228013,962941045-963100578",
    "966855229-967807936,968520967-968679752",
    "972435901-973388607,974100890-974260423",
    "978018819-978971525,979683808-979843341",
    "983600239-984552945,985265228-985424761",
    "989182408-990134366,990847397-991006931",
    "994764578-995717284,996430316-996589100",
    "1000345249-1001297955,1002010238-1002169771",
    "1005927418-1006880124,1007593156-1007751940",
    "1011508089-1012460047,1013173078-1013332612",
    "1017089510-1018041467,1018754499-1018913283",
    "1022670181-1023622138,1024335170-1024493954",
    "1028250103-1029202060,1029915092-1030074625",
    "1033831523-1034784230,1035496512-1035656046",
    "1039413693-1040365650,1041078682-1041238215",
    "1044996611-1045948568,1046661600-1046820384",
    "1050578031-1051529988,1052243020-1052402553",
    "1056159451-1057112158,1057824440-1057983974",
    "1061742370-1062694327,1063407359-1063566143",
    "1067323790-1068276496,1068988779-1069148312",
    "1072905210-1073857916,1074570948-1074729732",
    "1078488877-1079441584,1080153866-1080313400",
    "1084070298-1085022255,1085735286-1085894820",
    "1089651718-1090604424,1091316707-1091476240",
    "1095234636-1096186593,1096899625-1097058409",
    "1100813809-1101765767,1102478798-1102638332",
    "1106396728-1107349434,1108061716-1108221250",
    "1111978148-1112930105,1113643137-1113802670",
    "1117559568-1118512274,1119224557-1119384090",
    "1123141737-1124094444,1124806726-1124966260",
    "1128725405-1129677362,1130390393-1130549927",
    "1134305327-1135258033,1135971065-1136129849",
    "1139885998-1140837955,1141550987-1141710520",
    "1145466669-1146419376,1147131658-1147291192",
    "1151049588-1152001545,1152714576-1152874110",
    "1156631757-1157583714,1158296746-1158456279",
    "1162211679-1163164385,1163877417-1164036201",
    "1167793099-1168745057,1169458088-1169617622",
    "1173373771-1174325728,1175038759-1175198293",
    "1178954442-1179906399,1180619431-1180778964",
    "1184535113-1185487070,1186200102-1186359635",
    "1190115035-1191067742,1191780024-1191939558",
    "1195697954-1196649911,1197362943-1197522476",
    "1201280123-1202232829,1202945112-1203104645",
    "1206861543-1207814249,1208526532-1208686065",
    "1212442963-1213395670,1214108701-1214267486",
    "1218024384-1218976341,1219689373-1219848906",
    "1223604306-1224557012,1225269295-1225428828",
    "1229186475-1230139181,1230851464-1231010997",
    "1234768644-1235720602,1236433633-1236593167",
    "1240350814-1241303520,1242016551-1242175336",
    "1245931485-1246884191,1247597223-1247756007",
    "1251513654-1252465611,1253178643-1253338176",
    "1257096572-1258048530,1258761561-1258921095",
    "1262677993-1263630699,1264342981-1264502515",
    "1268260911-1269212868,1269925900-1270085433",
    "1273842331-1274795037,1275508069-1275666853",
    "1279424500-1280376458,1281089489-1281249023",
    "1285005172-1285957129,1286670160-1286829694",
    "1290586592-1291538549,1292251581-1292411114",
    "1296168012-1297119969,1297833001-1297991785",
    "1301747934-1302699892,1303412923-1303572457",
    "1307329355-1308282061,1308995092-1309153877",
    "1312910026-1313861983,1314575015-1314733799",
    "1318492195-1319444152,1320157184-1320316717",
    "1324072866-1325024824,1325737855-1325896640",
    "1329654287-1330606244,1331319276-1331478809",
    "1335235707-1336187664,1336900696-1337059480",
    "1340817876-1341770582,1342482865-1342642398",
    "1346398547-1347351254,1348063536-1348223070",
    "1351980717-1352932674,1353645706-1353805239",
    "1357562137-1358514094,1359227126-1359386659",
    "1363144306-1364097012,1364809295-1364968828",
    "1368724977-1369676935,1370389966-1370549500",
    "1374305649-1375258355,1375971387-1376130171",
    "1379888567-1380840524,1381553556-1381712340",
    "1385471485-1386424191,1387137223-1387296007",
    "1391053654-1392005612,1392718643-1392877428",
    "1396633577-1397585534,1398298565-1398458099",
    "1402215746-1403167703,1403880735-1404040268",
    "1407797166-1408749123,1409462155-1409620939",
    "1413379335-1414331293,1415044324-1415203858",
    "1418960756-1419912713,1420625744-1420784529",
    "1424542925-1425495631,1426208663-1426367447",
    "1430122847-1431075553,1431787836-1431947369",
    "1435702020-1436654727,1437367758-1437526543",
    "1441283441-1442236147,1442949179-1443107963",
    "1446867108-1447819065,1448532097-1448691630",
    "1452447779-1453400485,1454113517-1454272301",
    "1458028450-1458980408,1459693439-1459852973",
    "1463609871-1464561828,1465274860-1465434393",
    "1469192040-1470143997,1470857029-1471016562",
    "1474772711-1475724668,1476437700-1476597233",
    "1480353382-1481305340,1482018371-1482177905",
    "1485935552-1486887509,1487600541-1487760074",
    "1491517721-1492470427,1493182710-1493342243",
    "1497100639-1498052596,1498765628-1498925161",
    "1502681310-1503634017,1504346299-1504505833",
    "1508260484-1509212441,1509925473-1510085006",
    "1513841155-1514793112,1515506144-1515664928",
    "1519423324-1520375281,1521088313-1521247846",
    "1525004744-1525957451,1526670482-1526829267",
    "1530586165-1531538122,1532251154-1532410687",
    "1536167585-1537119542,1537832574-1537992107",
    "1541387995-1542069570,1542578878-1542693473",
  };
}

// Function to execute the request program with arguments
void callRequestProgram(const std::string& executablePath, const std::string& requestType, const std::string& url, const std::string& param, int id) {
  std::string command = executablePath + " " + requestType + " " + url + " " + param;
  // std::cout << "Thread " << id << " executing: " << command << std::endl;
  int result = system(command.c_str());
  if (result != 0) {
    std::cerr << "Thread " << id << " failed to execute command." << std::endl;
  }//  else {
  //   std::cout << "Thread " << id << " completed successfully." << std::endl;
  // }
}

// Function to execute the request program with arguments
void callRequestProgramRanges(const std::string& executablePath, const std::string& requestType, const std::string& url, const std::vector<std::string>& params, int id) {
  // std::cout << "Thread " << id << " executing: " << std::endl;
  int result;
  for (const std::string& param : params) {
    std::string command = executablePath + " " + requestType + " " + url + " " + param;
    // std::cout << "   " << command << std::endl;
    result = system(command.c_str());
    if (result != 0) {
      break;
    }
  }
  
  if (result != 0) {
    std::cerr << "Thread " << id << " failed to execute command." << std::endl;
  }//  else {
  //   std::cout << "Thread " << id << " completed successfully." << std::endl;
  // }
}

int main(int argc, char* argv[]) {
  if (argc != 4) {
    std::cerr << "Usage: " << argv[0] << " <path_to_executable> <request_type> <n>\n";
    std::cerr << "Request types:\n  1. range\n  2. unfiltered_query\n  3. filtered_query\n";
    return 1;
  }

  std::string executablePath = argv[1];
  std::string requestType = argv[2];
  int n = std::stoi(argv[3]);

  if (n <= 0) {
    std::cerr << "Number of concurrent requests (n) must be greater than 0." << std::endl;
    return 1;
  }

  std::string url;
  std::string param;

  // Determine request type and parameter
  if (requestType == "range") {
    url = "http://localhost:8080/range";
    std::vector<std::string> params = getBounds();
    std::vector<std::thread> threads;
    // Launch n threads for query requests
    for (int i = 0; i < n; ++i) {
      threads.emplace_back(callRequestProgramRanges, executablePath, requestType, url, params, i + 1);
    }
    // Wait for all threads to complete
    for (auto& t : threads) {
      t.join();
    }
    return 0; // Exit early since range requests are sequential
  } else if (requestType == "unfiltered_query") {
    requestType = "query";
    url = "http://localhost:8080/query";
    param = "\"SELECT l_shipdate, l_discount, l_quantity, l_extendedprice FROM parquet_data\"";
  } else if (requestType == "filtered_query") {
    requestType = "query";
    url = "http://localhost:8080/query";
    param = "\"SELECT l_discount, l_extendedprice FROM parquet_data WHERE l_shipdate >= date '1994-01-01' AND l_shipdate < date '1995-01-01' AND l_discount >= 0.059 AND l_discount <= 0.061 AND l_quantity < 24\"";
  } else {
    std::cerr << "Invalid request type. Use 'range', 'unfiltered_query', or 'filtered_query'." << std::endl;
    return 1;
  }

  std::vector<std::thread> threads;

  // Launch n threads for query requests
  for (int i = 0; i < n; ++i) {
    threads.emplace_back(callRequestProgram, executablePath, requestType, url, param, i + 1);
  }

  // Wait for all threads to complete
  for (auto& t : threads) {
    t.join();
  }

  std::cout << "All requests completed." << std::endl;
  return 0;
}
